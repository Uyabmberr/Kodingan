"use strict";Object.defineProperty(exports, "__esModule", {value: true}); function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { newObj[key] = obj[key]; } } } newObj.default = obj; return newObj; } } function _nullishCoalesce(lhs, rhsFn) { if (lhs != null) { return lhs; } else { return rhsFn(); } } async function _asyncNullishCoalesce(lhs, rhsFn) { if (lhs != null) { return lhs; } else { return await rhsFn(); } } function _optionalChain(ops) { let lastAccessLHS = undefined; let value = ops[0]; let i = 1; while (i < ops.length) { const op = ops[i]; const fn = ops[i + 1]; i += 2; if ((op === 'optionalAccess' || op === 'optionalCall') && value == null) { return undefined; } if (op === 'access' || op === 'optionalAccess') { lastAccessLHS = value; value = fn(value); } else if (op === 'call' || op === 'optionalCall') { value = fn((...args) => value.call(lastAccessLHS, ...args)); lastAccessLHS = undefined; } } return value; } async function _asyncOptionalChain(ops) { let lastAccessLHS = undefined; let value = ops[0]; let i = 1; while (i < ops.length) { const op = ops[i]; const fn = ops[i + 1]; i += 2; if ((op === 'optionalAccess' || op === 'optionalCall') && value == null) { return undefined; } if (op === 'access' || op === 'optionalAccess') { lastAccessLHS = value; value = await fn(value); } else if (op === 'call' || op === 'optionalCall') { value = await fn((...args) => value.call(lastAccessLHS, ...args)); lastAccessLHS = undefined; } } return value; }var k="https://api.vercel.com/bot-protection",h=()=>process.env.OVERRIDE_BOTID_SERVER_URL?process.env.OVERRIDE_BOTID_SERVER_URL:k;var B=Symbol.for("@vercel/request-context"),l=()=>_nullishCoalesce(_optionalChain([globalThis, 'access', _ => _[B], 'optionalAccess', _2 => _2.get, 'optionalCall', _3 => _3()]), () => ({}));async function m(e){let o=l();if(o.headers||process.env.NODE_ENV!=="development")return{...o.headers||{},url:o.url||""};let t=await T();if(t)return x(t);if(e){let n={};for(let[i,r]of Object.entries(e))typeof r=="string"?n[i.toLowerCase()]=r:Array.isArray(r)&&(n[i.toLowerCase()]=r.join(", "));return n}return{}}async function T(){try{let{headers:e}=await Promise.resolve().then(() => _interopRequireWildcard(require("next/headers")));return e()}catch (e2){return null}}function x(e){let o={};return e.forEach((t,n)=>{o[n]=t}),o}async function g(){return C()}function C(){let e=_nullishCoalesce(_optionalChain([l, 'call', _4 => _4(), 'access', _5 => _5.headers, 'optionalAccess', _6 => _6["x-vercel-oidc-token"]]), () => (process.env.VERCEL_OIDC_TOKEN));if(!e)throw new Error("The 'x-vercel-oidc-token' header is missing from the request. Do you have the OIDC option enabled in the Vercel project settings?");return e}var y=e=>{let o=_nullishCoalesce(_nullishCoalesce(e.cookie, () => (e.Cookie)), () => (""));return o?o.split(";").map(t=>t.trim()).filter(t=>t.length>0).map(t=>{let[n,...i]=t.split("="),r=i.join("=");return{name:n.trim(),value:r.trim()}}):[]};var H=e=>{let{authorization:o,...t}=e,i=y(t).filter(a=>a.name.startsWith("KP_")),r={};for(let a of i)r[a.name]=a.value;return Object.keys(r).length>0?t.cookie=Object.entries(r).map(([a,f])=>`${a}=${f}`).join("; "):t.cookie=void 0,t};var w=e=>{try{return new URL(e)}catch (e3){return null}},z= exports.checkBotId =async({developmentOptions:e,advancedOptions:o}={})=>{if(_optionalChain([o, 'optionalAccess', _7 => _7.checkLevel])!==void 0&&o.checkLevel!=="deepAnalysis"&&o.checkLevel!=="basic")throw new Error(`Invalid checkLevel "${o.checkLevel}". Must be one of: deepAnalysis, basic`);let t=await m(_optionalChain([o, 'optionalAccess', _8 => _8.headers])),n=t.host||"unknown host",i=_optionalChain([w, 'call', _9 => _9(t.url||""), 'optionalAccess', _10 => _10.pathname])||t["x-path"]||"<your protected endpoint>",r=t["x-method"]||"POST",a=t["x-is-human"],f=_nullishCoalesce(_optionalChain([e, 'optionalAccess', _11 => _11.isDevelopment]), () => (process.env.NODE_ENV!=="production"));if(a||(process.env.NODE_ENV!=="production"||process.env.VERCEL_ENV!=="production"?console.error(`Possible misconfiguration of Vercel BotId. 
Ensure that the client-side protection is properly configured for '${r} ${i}'.
Add the following item to your BotId client side protection:
{
  path: '${i}',
  method: '${r}',
}
More info at https://vercel.com/docs/botid/get-started#add-client-side-protection`):console.warn(`Possible misconfiguration of Vercel BotId or malicious request to '${r} ${i}'. More info at https://vercel.com/docs/botid/get-started#add-client-side-protection`)),f&&_optionalChain([e, 'optionalAccess', _12 => _12.bypass]))return{isHuman:e.bypass==="HUMAN",isBot:e.bypass==="BAD-BOT",isVerifiedBot:e.bypass==="GOOD-BOT",bypassed:!1};if(f)return console.warn("[Dev Only] Without setting the developmentOptions.bypass value, the bot protection will return HUMAN."),{isHuman:!0,isBot:!1,isVerifiedBot:!1,bypassed:!0};let R=h(),u=await _asyncNullishCoalesce(await _asyncOptionalChain([o, 'optionalAccess', async _13 => _13.vercelOidcToken]), async () => (await g()));if(!u)throw new Error("VERCEL_OIDC_TOKEN is not set");let d=l(),b=H(t),v={url:d.url||"",method:r,headers:Object.entries(b),vercelOidcToken:u,forceCheckLevel:_optionalChain([o, 'optionalAccess', _14 => _14.checkLevel]),extraAllowedHosts:_optionalChain([o, 'optionalAccess', _15 => _15.extraAllowedHosts])},E=`${R}/v1/is-bot?v=${3}  `,s=await(await fetch(E,{method:"POST",body:JSON.stringify(v),headers:{"Content-Type":"application/json","user-agent":`Vercel/BotId (${n})`,"x-vercel-oidc-token":u}})).json();if(!d)throw new Error("Must be deployed on Vercel to access response headers");if(!d.mutateResponseHeadersBeforeFlush)throw new Error("Must be deployed on Vercel to set response headers");if(_optionalChain([s, 'access', _16 => _16.responseHeadersToSet, 'optionalAccess', _17 => _17.addHeaders]))for(let c of s.responseHeadersToSet.addHeaders)d.mutateResponseHeadersBeforeFlush(p=>{p.append(c.key,c.value)});if(_optionalChain([s, 'access', _18 => _18.responseHeadersToSet, 'optionalAccess', _19 => _19.addValuesToHeaders]))for(let c of s.responseHeadersToSet.addValuesToHeaders)d.mutateResponseHeadersBeforeFlush(p=>{p.append(c.key,c.value)});if(_optionalChain([s, 'access', _20 => _20.responseHeadersToSet, 'optionalAccess', _21 => _21.replaceHeaders]))for(let c of s.responseHeadersToSet.replaceHeaders)d.mutateResponseHeadersBeforeFlush(p=>{p.set(c.key,c.value)});return{isHuman:!s.isBot,isBot:s.isBot,isVerifiedBot:s.isVerifiedBot,verifiedBotName:s.verifiedBotName,verifiedBotCategory:s.verifiedBotCategory,bypassed:s.bypassed,classificationReason:s.classificationReason,..._optionalChain([o, 'optionalAccess', _22 => _22.returnResponseHeaders])&&{responseHeaders:s.responseHeadersToSet}}};exports.checkBotId = z;
